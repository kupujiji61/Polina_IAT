define(['questAPI'], function (Quest) {
    let API = new Quest();
    let isTouch = API.getGlobal().$isTouch;

    /********* Страница *********/
    API.addPagesSet('resultsPage', {
        noSubmit: false,
        header: 'Результаты теста скрытых ассоциаций',
        decline: false,
        autoFocus: true,
        progressBar: 'Страница <%= pagesMeta.number %> из 1',
        submitText: 'Далее'
    });

    /********* Вопрос-описание (на самом деле просто текст) *********/
    API.addQuestionsSet('resultsInfo', {
        type: 'info',
        name: 'iat_results_info',
        autoSubmit: false,
        decline: false,
        stem: function () {
            // Достаём глобальные данные
            let g = API.getGlobal() || {};
            let r = g.raceiat || {};
            let hasResult = typeof r.d === 'number';

            if (!hasResult) {
                return [
                    '<p class="lead"><b>К сожалению, результат теста не удалось рассчитать.</b></p>',
                    '<p>Это могло произойти из-за большого количества ошибок или технического сбоя.</p>',
                    '<p>Вы всё равно можете нажать «Далее», чтобы завершить исследование.</p>'
                ].join('');
            }

            let dStr = r.d.toFixed(2);
            let fb = r.feedback || '';

            return [
                '<p class="lead"><b>Ваш результат по тесту скрытых ассоциаций</b></p>',
                '<p><b>D-score:</b> ', dStr, '</p>',
                '<p>', fb, '</p>',
                '<hr>',
                '<p><b>Что измеряет этот тест?</b></p>',
                '<p>Тест имплицитных ассоциаций (Implicit Association Test, IAT) измеряет скорость, с которой человек ',
                'соотносит разные категории (например, Полину и «хорошее») со словами и картинками.</p>',
                '<p>Предполагается, что чем быстрее вы реагируете, когда вместе появляются «согласующиеся» для вас ',
                'сочетания (например, Полина + приятные слова), тем сильнее автоматическая связь между ними.</p>',
                '<p>Положительное значение D-score означает более быструю реакцию при сочетании Полины с «хорошим» ',
                'по сравнению с альтернативными сочетаниями. Отрицательное значение — наоборот.</p>',
                '<p>Чем больше по модулю значение D-score, тем сильнее выражена ассоциация. Значения, близкие к 0, ',
                'показывают, что заметного перекоса в скорости реакций между сравниваемыми парами нет.</p>'
            ].join('');
        }
    });

    /********* Последовательность *********/
    API.addSequence([
        {
            inherit: 'resultsPage',
            questions: { inherit: 'resultsInfo' }
        }
    ]);

    return API.script;
});

