define(['questAPI'], function (Quest) {
    let API = new Quest();

    /********* Страница *********/
    API.addPagesSet('resultsPage', {
        noSubmit: false,
        header: 'Результаты теста скрытых ассоциаций',
        decline: false,
        autoFocus: true,
        progressBar: 'Страница <%= pagesMeta.number %> из 1',
        submitText: 'Далее'
    });

    /********* Текстовый блок с результатами *********/
    API.addQuestionsSet('resultsInfo', {
        type: 'info',
        name: 'iat_results_info',
        autoSubmit: false,
        decline: false,

        // ВАЖНО: одна строка с EJS-шаблоном
        stem: [
            // --- JS внутри шаблона: достаём глобальные данные и считаем показатели ---
            '<% ',
            '  var r    = (global && global.raceiat) ? global.raceiat : {};',  // объект с результатами
            '  var dNum = Number(r.d);',                                       // D-score как число
            '  var fb   = r.feedback || "";',                                  // текстовая интерпретация
            '  var absD = Math.abs(dNum);',                                    // |D|
            '  var mag  = "";',                                                // словесная сила эффекта
            '  if (!isNaN(dNum)) {',
            '    if (absD < 0.15)       mag = "почти нет эффекта";',
            '    else if (absD < 0.35)  mag = "слабый эффект";',
            '    else if (absD < 0.65)  mag = "умеренный эффект";',
            '    else                   mag = "сильный эффект";',
            '  }',
            '%>',

            // --- Заголовок результатов ---
            '<p class="lead"><b>Ваш результат по тесту скрытых ассоциаций</b></p>',

            // D-score
            '<p><b>D-score:</b> ',
            '<%= isNaN(dNum) ? "не удалось вычислить" : dNum.toFixed(2) %>',
            '</p>',

            // Сила эффекта (если удалось посчитать D)
            '<% if (!isNaN(dNum)) { %>',
            '<p><b>Сила эффекта:</b> <%= mag %></p>',
            '<% } %>',

            // Текстовая интерпретация из IAT-скрипта (fb)
            '<p>',
            '<%= fb || "Интерпретация результата недоступна." %>',
            '</p>',

            '<hr>',

            // --- Объяснение сути теста ---
            '<p><b>Что измеряет этот тест?</b></p>',
            '<p>Тест имплицитных ассоциаций (Implicit Association Test, IAT) измеряет скорость, с которой человек ',
            'соотносит разные категории (например, Полину и «хорошее») со словами и картинками.</p>',

            '<p>Предполагается, что чем быстрее вы реагируете, когда вместе появляются «согласующиеся» для вас ',
            'сочетания (например, Полина + приятные слова), тем сильнее автоматическая связь между ними.</p>',

            '<p>Положительное значение D-score означает более быструю реакцию при сочетании Полины с «хорошим» ',
            'по сравнению с альтернативными сочетаниями. Отрицательное значение — наоборот.</p>',

            '<p>Чем больше по модулю значение D-score, тем сильнее выражена ассоциация. Значения, близкие к 0, ',
            'показывают, что заметного перекоса в скорости реакций между сравниваемыми парами нет.</p>',

            '<p><b>Как интерпретировать величину D-score?</b></p>',
            '<ul>',
            '<li>|D| &lt; 0.15 — почти нет эффекта</li>',
            '<li>0.15 ≤ |D| &lt; 0.35 — слабый эффект</li>',
            '<li>0.35 ≤ |D| &lt; 0.65 — умеренный эффект</li>',
            '<li>|D| ≥ 0.65 — сильный эффект</li>',
            '</ul>'
        ].join('')
    });

    /********* Последовательность *********/
    API.addSequence([
        {
            inherit: 'resultsPage',
            questions: { inherit: 'resultsInfo' }
        }
    ]);

    return API.script;
});
